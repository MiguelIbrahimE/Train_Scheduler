<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        #map {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }
        .leaflet-container { font-size: 1rem; }
        
        /* Legend styles */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 20px;
            font-size: 14px;
        }
        .legend i {
            width: 20px;
            height: 3px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        .legend .tunnel { 
            background: #333; 
            border: 1px dashed #fff;
        }
        .legend .coastal { background: #2E7D32; }
        .legend .inland { background: #1976D2; }
        .legend .station-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #FF5722;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        .legend .railyard-icon {
            width: 20px;
            height: 15px;
            background: #795548;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="folium-map" id="map"></div>
</body>
<script>
    // Initialize the map
    var map = L.map('map', {
        center: [34.15, 35.70],
        zoom: 9,
        zoomControl: true,
        preferCanvas: false,
    });

    // Add tile layer
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Define the realistic railway route following Lebanese coastal highway and terrain
    // This follows roughly the path of the existing coastal highway to minimize property impact
    var railwayRoute = [
        // Beirut - Start inland to avoid port and dense downtown
        [33.8938, 35.5018],  // Beirut Station
        [33.9100, 35.5150],  // Curve northeast avoiding downtown
        [33.9250, 35.5280],  // Follow existing transport corridor
        [33.9400, 35.5450],  // Parallel to highway
        [33.9550, 35.5650],  // Through Antelias area
        [33.9700, 35.5850],  // Approaching Dbayeh
        [33.9850, 35.6050],  // Nahr el-Kalb crossing
        [34.0000, 35.6200],  // Jounieh approach
        [34.0150, 35.6250],  // Jounieh coastal
        [34.0300, 35.6300],  // Kaslik area
        [34.0450, 35.6350],  // Tabarja
        [34.0600, 35.6400],  // Safra
        [34.0750, 35.6450],  // Bouar
        [34.0900, 35.6480],  // Approaching Jbeil
        [34.1200, 35.6485],  // Jbeil (Byblos) Station - middle station
        [34.1350, 35.6500],  // North of Jbeil
        [34.1500, 35.6520],  // Fidar area
        [34.1650, 35.6540],  // Halat
        [34.1800, 35.6560],  // Maameltein
        [34.1950, 35.6580],  // Approaching Batroun
        [34.2100, 35.6600],  // South Batroun
        [34.2250, 35.6620],  // Batroun bypass (inland to avoid old city)
        [34.2400, 35.6650],  // North Batroun
        [34.2550, 35.6700],  // Kfaraabida
        [34.2700, 35.6750],  // Hamat
        [34.2850, 35.6850],  // Approaching Chekka
        [34.3000, 35.7000],  // Chekka industrial area
        [34.3150, 35.7150],  // Chekka north
        [34.3300, 35.7300],  // Anfeh approach
        [34.3450, 35.7450],  // Anfeh area
        [34.3600, 35.7600],  // Ras el-Natroun
        [34.3750, 35.7750],  // Deir Amar
        [34.3900, 35.7900],  // El-Mina approach
        [34.4050, 35.8100],  // South Tripoli
        [34.4200, 35.8300],  // Tripoli approach
        [34.4367, 35.8497]   // Tripoli Station
    ];

    // Define tunnel sections (through difficult terrain)
    var tunnelSections = [
        {start: 5, end: 6},    // Nahr el-Kalb gorge
        {start: 21, end: 22},  // Batroun rocky outcrop
        {start: 30, end: 32}   // Ras el-Natroun cliffs
    ];

    // Define stations
    var stations = [
        {name: "Beirut Central Station", coords: [33.8938, 35.5018], type: "terminal"},
        {name: "Jbeil (Byblos) Station", coords: [34.1200, 35.6485], type: "major"},
        {name: "Tripoli Station", coords: [34.4367, 35.8497], type: "terminal"}
    ];

    // Define railyard - placed inland near Chekka industrial area, away from water
    var railyard = {
        name: "Chekka Railway Maintenance Yard",
        coords: [34.3050, 35.6950],  // Inland from coast
        size: 0.015
    };

    // Function to determine if a segment is a tunnel
    function isTunnel(index) {
        for (var i = 0; i < tunnelSections.length; i++) {
            if (index >= tunnelSections[i].start && index < tunnelSections[i].end) {
                return true;
            }
        }
        return false;
    }

    // Draw the railway line
    for (var i = 0; i < railwayRoute.length - 1; i++) {
        var segment = [railwayRoute[i], railwayRoute[i + 1]];
        var isCoastal = railwayRoute[i][1] > 35.62; // Roughly coastal vs inland
        var tunnel = isTunnel(i);
        
        var polyline = L.polyline(segment, {
            color: tunnel ? '#333' : (isCoastal ? '#2E7D32' : '#1976D2'),
            weight: 4,
            opacity: 0.8,
            dashArray: tunnel ? '10, 5' : null,
            smoothFactor: 1.5
        }).addTo(map);
        
        // Add popup with segment info
        var segmentType = tunnel ? 'Tunnel' : (isCoastal ? 'Coastal Railway' : 'Inland Railway');
        polyline.bindPopup(`<b>${segmentType}</b><br>Segment ${i + 1}`);
    }

    // Add connection to railyard
    var railyardConnection = L.polyline([
        [34.3000, 35.7000],  // From main line at Chekka
        railyard.coords
    ], {
        color: '#795548',
        weight: 3,
        opacity: 0.8,
        dashArray: '5, 5'
    }).addTo(map);
    railyardConnection.bindPopup('<b>Railyard Access Track</b>');

    // Add station markers
    stations.forEach(function(station) {
        var marker = L.circleMarker(station.coords, {
            radius: station.type === 'terminal' ? 10 : 8,
            fillColor: '#FF5722',
            color: 'white',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.9
        }).addTo(map);
        
        marker.bindPopup(`<b>${station.name}</b><br>Type: ${station.type}`);
        
        // Add station labels
        var label = L.divIcon({
            className: 'station-label',
            html: `<div style="background: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.4);">${station.name}</div>`,
            iconAnchor: station.name.includes('Beirut') ? [-10, 20] : 
                       station.name.includes('Tripoli') ? [80, -10] : [60, -10]
        });
        L.marker(station.coords, {icon: label}).addTo(map);
    });

    // Add railyard
    var railyardBounds = [
        [railyard.coords[0] - railyard.size/2, railyard.coords[1] - railyard.size/2],
        [railyard.coords[0] + railyard.size/2, railyard.coords[1] + railyard.size/2]
    ];
    
    var railyardRect = L.rectangle(railyardBounds, {
        color: '#795548',
        weight: 2,
        fillColor: '#795548',
        fillOpacity: 0.3
    }).addTo(map);
    
    railyardRect.bindPopup(`<b>${railyard.name}</b><br>Maintenance and storage facility<br>Located inland to avoid coastal flooding`);
    
    // Add railyard label
    var railyardLabel = L.divIcon({
        className: 'railyard-label',
        html: `<div style="background: #795548; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.4);">Railway Yard</div>`,
        iconAnchor: [45, -10]
    });
    L.marker(railyard.coords, {icon: railyardLabel}).addTo(map);

    // Add legend
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<h4 style="margin: 0 0 10px 0;">Beirut-Tripoli Railway</h4>' +
                        '<i class="coastal"></i> Coastal Railway<br>' +
                        '<i class="inland"></i> Inland Railway<br>' +
                        '<i class="tunnel"></i> Tunnel Section<br>' +
                        '<div style="margin-top: 8px;">' +
                        '<span class="station-icon"></span> Station<br>' +
                        '<span class="railyard-icon"></span> Railway Yard</div>' +
                        '<div style="margin-top: 8px; font-size: 11px; color: #666;">' +
                        'Total Distance: ~85 km<br>' +
                        'Travel Time: ~1.5 hours</div>';
        return div;
    };
    legend.addTo(map);

    // Add scale
    L.control.scale({imperial: false}).addTo(map);

    // Add distance measurement tool
    var totalDistance = 0;
    for (var i = 0; i < railwayRoute.length - 1; i++) {
        var latlng1 = L.latLng(railwayRoute[i][0], railwayRoute[i][1]);
        var latlng2 = L.latLng(railwayRoute[i + 1][0], railwayRoute[i + 1][1]);
        totalDistance += latlng1.distanceTo(latlng2);
    }
    console.log('Total railway distance: ' + (totalDistance / 1000).toFixed(2) + ' km');
</script>
</html>